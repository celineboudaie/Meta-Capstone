import os
import requests
from parse_rest.connection import register
from parse_rest.datatypes import Object

class Product(Object):
    pass

headers = {
  'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36',
}

categories = ['face wash', 'moisturizer', 'sunscreen', 'eye cream', 'makeup remover', 'toners']

for category in reversed(categories):
  print(f"Looking at category {category}")
  r = requests.get(f"https://www.sephora.com/api/catalog/search?type=keyword&q={category}", headers=headers)
  responsejson = r.json()
  
  for product in responsejson["products"]:
    try:
      productRequest = requests.get(f"https://www.sephora.com/api2/catalog/products/{product['productId']}", headers=headers)
      
      productjson = productRequest.json()
      query = Product.Query.filter(ID=product['productId'])
  
      # Check if we already have it in the DB
      if len(query) > 0:
        p = query[0]
      else:
        p = Product()
      p.ID = product['productId']
      p.Category = category
      p.Name = product['productName']
      p.Brand = product['brandName']
      ing = productjson['currentSku']['ingredientDesc']
      x = ing.split(", ")
      p.Ingredients = x
      p.Price = product['currentSku']['listPrice']
      p.save()
      print(f"Added product {product['productId']}")
    except: 
      pass
